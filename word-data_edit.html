// 配置GitHub仓库信息
const GITHUB_REPO = 'Coco-yum/Babei'; // 修改为正确的格式
const CSV_PATH = 'word-data.csv'; // CSV文件路径
const BRANCH = 'main'; // 默认分支

let allData = [];
let filteredData = [];
let currentEditIndex = -1;

// 初始化
document.addEventListener('DOMContentLoaded', async () => {
    await loadFromGitHub();
    populateModuleFilter();
});

// 从GitHub加载CSV
async function loadFromGitHub() {
    showLoading(true);
    try {
        const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${BRANCH}/${CSV_PATH}?t=${Date.now()}`;
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`加载失败: ${response.status}`);
        }

        const csvText = await response.text();
        allData = parseCSV(csvText);
        applyFilters();
        showNotification('数据加载成功', 'success');
    } catch (error) {
        console.error('加载CSV失败:', error);
        showNotification(`加载失败: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}

// 解析CSV
function parseCSV(csvText) {
    const rows = csvText.split('\n').filter(row => row.trim() !== '');
    if (rows.length === 0) return [];

    const headers = rows[0].split(',').map(h => h.trim());
    const requiredFields = ['module', 'type', 'chinese', 'english'];

    if (!requiredFields.every(field => headers.includes(field))) {
        throw new Error('CSV文件缺少必要字段');
    }

    return rows.slice(1).map((row, index) => {
        const values = splitCSVRow(row);
        const item = {};

        headers.forEach((header, i) => {
            item[header] = values[i] ? values[i].trim().replace(/^"|"$/g, '') : '';
        });

        // 确保有status字段
        if (!('status' in item)) {
            item.status = '0';
        }

        return item;
    });
}

// 处理带引号的CSV行
function splitCSVRow(row) {
    const result = [];
    let inQuotes = false;
    let currentField = '';

    for (let i = 0; i < row.length; i++) {
        const char = row[i];

        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(currentField);
            currentField = '';
        } else {
            currentField += char;
        }
    }

    result.push(currentField);
    return result;
}

// 填充模块筛选器
function populateModuleFilter() {
    const moduleFilter = document.getElementById('filter-module');
    const modules = [...new Set(allData.map(item => item.module))].sort();

    modules.forEach(module => {
        const option = document.createElement('option');
        option.value = module;
        option.textContent = module;
        moduleFilter.appendChild(option);
    });
}

// 应用筛选
function applyFilters() {
    const module = document.getElementById('filter-module').value;
    const type = document.getElementById('filter-type').value;
    const status = document.getElementById('filter-status').value; // 修改引号使用

    filteredData = allData.filter(item => {
        return (!module || item.module === module) &&
               (!type || item.type === type) &&
               (status === '' || item.status === status);
    });

    renderTable();
}

// 重置筛选
function resetFilters() {
    document.getElementById('filter-module').value = '';
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-status').value = ''; // 修改引号使用
    applyFilters();
}

// 渲染表格
function renderTable() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';

    if (filteredData.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="text-align: center;">没有找到匹配的数据</td>`;
        tbody.appendChild(tr);
        return;
    }

    filteredData.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.module}</td>
            <td>${getTypeDisplayName(item.type)}</td>
            <td>${item.chinese}</td>
            <td>${item.english}</td>
            <td>
                <span class="status-badge status-${item.status}">
                    ${item.status === '0' ? '启用' : '禁用'}
                </span>
            </td>
            <td>
                <button onclick="editItem(${index})">编辑</button>
                <button onclick="toggleStatus(${index})" class="${item.status === '0' ? 'danger' : ''}">
                    ${item.status === '0' ? '禁用' : '启用'}
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 获取类型显示名称
function getTypeDisplayName(type) {
    const typeNames = {
        'words': '单词',
        'phrases': '词组',
        'sentences': '句子'
    };
    return typeNames[type] || type;
}

// 新增单词
function addNewItem() {
    currentEditIndex = -1;
    clearForm();
    document.getElementById('input-module').focus();
}

// 编辑单词
function editItem(index) {
    currentEditIndex = index;
    const item = filteredData[index];

    document.getElementById('input-module').value = item.module;
    document.getElementById('input-type').value = item.type;
    document.getElementById('input-chinese').value = item.chinese;
    document.getElementById('input-english').value = item.english;
    document.getElementById('input-status').value = item.status; // 修改引号使用

    window.scrollTo({ top: document.querySelector('.edit-form').offsetTop - 20, behavior: 'smooth' });
}

// 切换状态
function toggleStatus(index) {
    const item = filteredData[index];
    item.status = item.status === '0' ? '1' : '0';

    // 更新主数据
    const mainIndex = allData.findIndex(x => 
        x.module === item.module && 
        x.type === item.type && 
        x.chinese === item.chinese && 
        x.english === item.english
    );

    if (mainIndex !== -1) {
        allData[mainIndex].status = item.status;
    }

    renderTable();
    showNotification('状态已更新', 'success');
}

// 保存单词
function saveItem() {
    const module = document.getElementById('input-module').value.trim();
    const type = document.getElementById('input-type').value;
    const chinese = document.getElementById('input-chinese').value.trim();
    const english = document.getElementById('input-english').value.trim();
    const status = document.getElementById('input-status').value; // 修改引号使用

    if (!module || !type || !chinese || !english) {
        showNotification('请填写所有必填字段', 'error');
        return;
    }

    const newItem = { module, type, chinese, english, status };

    if (currentEditIndex === -1) {
        // 新增
        allData.push(newItem);
        showNotification('单词已添加', 'success');
    } else {
        // 编辑
        const oldItem = filteredData[currentEditIndex];

        // 更新主数据
        const mainIndex = allData.findIndex(x => 
            x.module === oldItem.module && 
            x.type === oldItem.type && 
            x.chinese === oldItem.chinese && 
            x.english === oldItem.english
        );

        if (mainIndex !== -1) {
            allData[mainIndex] = newItem;
        }

        showNotification('单词已更新', 'success');
    }

    applyFilters();
    clearForm();
    populateModuleFilter();
}

// 清空表单
function clearForm() {
    document.getElementById('input-module').value = '';
    document.getElementById('input-type').value = '';
    document.getElementById('input-chinese').value = '';
    document.getElementById('input-english').value = '';
    document.getElementById('input-status').value = '0'; // 修改引号使用
    currentEditIndex = -1;
}

// 导出CSV
function exportCSV() {
    if (allData.length === 0) {
        showNotification('没有数据可导出', 'error');
        return;
    }

    const headers = ['module', 'type', 'chinese', 'english', 'status'];
    const csvContent = [
        headers.join(','),
        ...allData.map(item => headers.map(header => 
            `"${item[header] || ''}"`
        ).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.href = url;
    link.setAttribute('download', 'word-data.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showNotification('CSV文件已生成', 'success');
}

// 保存到GitHub (需要用户手动操作)
function saveToGitHub() {
    exportCSV();
    showNotification(`
        请执行以下操作保存到GitHub:<br>
        1. 下载生成的CSV文件<br>
        2. 替换仓库中的 ${CSV_PATH} 文件<br>
        3. 提交并推送更改
    `, 'info', 10000);
}

// 显示通知
function showNotification(message, type = 'info', duration = 3000) {
    const notification = document.getElementById('notification');
    notification.textContent = '';
    notification.innerHTML = message;
    notification.className = 'notification';
    notification.classList.add(type);
    notification.style.display = 'block';

    setTimeout(() => {
        notification.style.display = 'none';
    }, duration);
}

// 显示加载状态
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// 显示帮助
function showHelp() {
    showNotification(`
        <strong>使用说明:</strong><br>
        1. 点击"从GitHub重新加载"获取最新数据<br>
        2. 使用筛选功能查找特定单词<br>
        3. 点击"编辑"修改单词或"禁用"按钮切换状态<br>
        4. 点击"新增单词"添加新条目<br>
        5. 点击"保存到GitHub"下载CSV并手动更新仓库
    `, 'info', 10000);
}
