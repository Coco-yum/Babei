<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby成长曲线</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- 先加载SQL.js核心库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/sql-wasm.js"></script>
    <!-- 配置SQL.js并初始化 -->
    <script>
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 配置SQL.js的WASM文件路径
            initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/${file}`
            }).then(SQL => {
                console.log('SQL.js库加载成功');
                // 将SQL对象存储到全局作用域
                window.SQL = SQL;
                // 初始化数据库
                initSQL();
            }).catch(error => {
                console.error('SQL.js初始化失败:', error);
                alert('SQL.js初始化失败，请检查网络连接。详细信息：' + error.message);
            });
        });
    </script>
    <link rel="stylesheet" href="baby_growth.css">
</head>
<body>
    <div class="container">
        <h1>Baby成长曲线记录</h1>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="chart">成长曲线</button>
            <button class="tab-btn" data-tab="add">添加记录</button>
            <button class="tab-btn" data-tab="data">详细数据</button>
        </div>
        
        <!-- 成长曲线tab -->
        <div id="chart" class="tab-content active">
            <div class="controls">
                <div class="baby-selector">
                    <input type="radio" id="baby-all" name="baby-select" value="all" checked>
                    <label for="baby-all">ALL</label>
                    <input type="radio" id="baby-eason" name="baby-select" value="EASON">
                    <label for="baby-eason">EASON</label>
                    <input type="radio" id="baby-jenny" name="baby-select" value="JENNY">
                    <label for="baby-jenny">JENNY</label>
                </div>
                <div class="chart-type-selector">
                    <label for="chart-type">图表类型:</label>
                    <select id="chart-type">
                        <option value="height">身高曲线</option>
                        <option value="weight">体重曲线</option>
                        <option value="both">身高体重对比</option>
                    </select>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="growth-chart"></canvas>
            </div>
        </div>
        
        <!-- 添加记录tab -->
        <div id="add" class="tab-content">
            <div class="add-data">
                <h2>添加新记录</h2>
                <form id="add-record-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="babyname">宝贝:</label>
                            <select id="babyname" required>
                                <option value="EASON">EASON</option>
                                <option value="JENNY">JENNY</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date">日期:</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="height">身高 (cm):</label>
                            <input type="number" id="height" step="0.1" placeholder="例如: 130">
                        </div>
                        <div class="form-group">
                            <label for="weight">体重 (kg):</label>
                            <input type="number" id="weight" step="0.1" placeholder="例如: 29">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="record">记录:</label>
                            <textarea id="record" placeholder="记录宝宝的日常情况"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn">添加记录</button>
                </form>
            </div>
        </div>
        
        <!-- 详细数据tab -->
        <div id="data" class="tab-content">
            <div class="data-table">
                <h2>详细数据</h2>
                <div class="baby-filter">
                    <label>选择宝贝:</label>
                    <div class="baby-checkbox-container">
                        <label><input type="checkbox" class="baby-checkbox" value="EASON" checked>EASON</label>
                        <label><input type="checkbox" class="baby-checkbox" value="JENNY" checked>JENNY</label>
                    </div>
                </div>
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>宝贝</th>
                            <th>身高 (cm)</th>
                            <th>体重 (kg)</th>
                            <th>记录</th>
                        </tr>
                    </thead>
                    <tbody id="data-body">
                        <!-- 数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let babyData = [];
        let growthChart = null;
        let db = null; // SQLite数据库对象
        
        // 颜色配置
        const colors = {
            'EASON': {
                height: 'rgba(255, 99, 132, 1)',
                weight: 'rgba(255, 159, 64, 1)',
                heightBg: 'rgba(255, 99, 132, 0.2)',
                weightBg: 'rgba(255, 159, 64, 0.2)'
            },
            'JENNY': {
                height: 'rgba(54, 162, 235, 1)',
                weight: 'rgba(75, 192, 192, 1)',
                heightBg: 'rgba(54, 162, 235, 0.2)',
                weightBg: 'rgba(75, 192, 192, 0.2)'
            }
        };
        
        // 初始化SQL.js并加载数据库
        async function initSQL() {
            try {
                console.log('开始初始化数据库...');
                
                // 检查SQL对象是否已存在
                if (typeof window.SQL === 'undefined') {
                    console.error('SQL对象未找到，请检查SQL.js库是否加载成功。');
                    alert('SQL.js库未加载成功，请检查网络连接。');
                    return;
                }
                
                console.log('SQL对象存在，开始读取数据库文件...');
                
                // 读取数据库文件
                const response = await fetch('Babydata.db');
                console.log('数据库文件获取成功，状态码:', response.status);
                
                if (!response.ok) {
                    throw new Error('数据库文件获取失败，状态码: ' + response.status);
                }
                
                const buffer = await response.arrayBuffer();
                console.log('数据库文件转换为ArrayBuffer成功，大小:', buffer.byteLength, '字节');
                
                // 创建数据库对象
                db = new window.SQL.Database(new Uint8Array(buffer));
                console.log('数据库对象创建成功');
                
                // 查询所有记录
                console.log('开始执行SQL查询...');
                const result = db.exec(`SELECT * FROM Babydata ORDER BY date ASC`);
                console.log('SQL查询执行成功，结果:', result);
                
                if (result.length > 0) {
                    const rows = result[0].values;
                    const columns = result[0].columns;
                    console.log('查询结果包含', rows.length, '条记录');
                    console.log('列名:', columns);
                    console.log('前5条记录:', rows.slice(0, 5));
                    
                    // 转换为对象数组
                    babyData = rows.map(row => {
                        const record = {};
                        columns.forEach((column, index) => {
                            // 将数据库列名映射到前端使用的键名
                            if (column === 'date') {
                                record['日期'] = row[index];
                            } else if (column === 'baby') {
                                record['babyname'] = row[index];
                            } else if (column === 'height') {
                                record['身高'] = row[index] !== null ? parseFloat(row[index]) : '';
                            } else if (column === 'weight') {
                                record['体重'] = row[index] !== null ? parseFloat(row[index]) : '';
                            } else if (column === 'record') {
                                record['记录'] = row[index] || '';
                            }
                        });
                        return record;
                    });
                    
                    console.log('数据转换完成，转换后的数据:', babyData.length, '条记录');
                    console.log('转换后的数据示例:', babyData.slice(0, 2));
                    
                    // 渲染图表和表格
                    renderChart();
                    renderTable();
                    console.log('图表和表格渲染完成');
                } else {
                    console.log('查询结果为空');
                    alert('数据库中没有记录');
                }
            } catch (error) {
                console.error('Error loading database:', error);
                alert('无法加载数据库文件: ' + error.message + '，请确保Babydata.db存在于同一目录下。');
            }
        }
        
        // 渲染图表
        function renderChart() {
            const babySelect = document.querySelector('input[name="baby-select"]:checked').value;
            const chartType = document.getElementById('chart-type').value;
            
            // 过滤数据
            let filteredData = babyData;
            if (babySelect !== 'all') {
                filteredData = babyData.filter(item => item['babyname'] === babySelect);
            }
            
            // 按日期排序
            filteredData.sort((a, b) => {
                // 简单的日期比较，实际项目中应使用更可靠的日期解析
                return a['日期'].localeCompare(b['日期']);
            });
            
            // 准备图表数据
            const chartData = prepareChartData(filteredData, chartType, babySelect);
            
            // 销毁现有图表
            if (growthChart) {
                growthChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('growth-chart').getContext('2d');
            growthChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: chartType === 'height' ? '身高 (cm)' : chartType === 'weight' ? '体重 (kg)' : '数值'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            },
                            grid: {
                                drawBorder: true
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 5,
                            hoverRadius: 7
                        },
                        line: {
                            tension: 0.4,
                            borderWidth: 2
                        }
                    },
                    spanGaps: true
                }
            });
        }
        
        // 格式化日期：每年只在第一个日期显示年份，后续只显示月-日
        function formatDates(dates) {
            const yearMap = {};
            const formattedDates = [];
            
            dates.forEach(date => {
                // 支持YYYY-MM-DD和YYYY/MM/DD格式
                const parts = date.split(/[-/]/);
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = parts[1];
                    const day = parts[2];
                    
                    if (!yearMap[year]) {
                        // 该年份的第一个日期，显示完整日期
                        formattedDates.push(`${year}/${month}/${day}`);
                        yearMap[year] = true;
                    } else {
                        // 该年份的其他日期，只显示月-日
                        formattedDates.push(`${month}/${day}`);
                    }
                } else {
                    // 格式不正确，保持原样
                    formattedDates.push(date);
                }
            });
            
            return formattedDates;
        }
        
        // 准备图表数据
        function prepareChartData(data, chartType, babySelect) {
            const datasets = [];
            const labels = [...new Set(data.map(item => item['日期']))];
            
            // 如果是单Baby或所有Baby
            if (babySelect === 'all') {
                // 所有Baby，为每个Baby创建独立的数据集
                const babies = [...new Set(data.map(item => item['babyname']))];
                
                babies.forEach(baby => {
                    const babyData = data.filter(item => item['babyname'] === baby);
                    
                    if (chartType === 'height' || chartType === 'both') {
                        datasets.push({
                            label: `${baby} - 身高`,
                            data: labels.map(label => {
                                const item = babyData.find(d => d['日期'] === label);
                                return item && item['身高'] ? item['身高'] : null;
                            }),
                            borderColor: colors[baby].height,
                            backgroundColor: colors[baby].heightBg,
                            yAxisID: 'y',
                            tension: 0.4
                        });
                    }
                    
                    if (chartType === 'weight' || chartType === 'both') {
                        datasets.push({
                            label: `${baby} - 体重`,
                            data: labels.map(label => {
                                const item = babyData.find(d => d['日期'] === label);
                                return item && item['体重'] ? item['体重'] : null;
                            }),
                            borderColor: colors[baby].weight,
                            backgroundColor: colors[baby].weightBg,
                            yAxisID: chartType === 'both' ? 'y1' : 'y',
                            tension: 0.4
                        });
                    }
                });
            } else {
                // 单个Baby
                if (chartType === 'height' || chartType === 'both') {
                    datasets.push({
                        label: `${babySelect} - 身高`,
                        data: data.map(item => item['身高'] || null),
                        borderColor: colors[babySelect].height,
                        backgroundColor: colors[babySelect].heightBg,
                        yAxisID: 'y',
                        tension: 0.4
                    });
                }
                
                if (chartType === 'weight' || chartType === 'both') {
                    datasets.push({
                        label: `${babySelect} - 体重`,
                        data: data.map(item => item['体重'] || null),
                        borderColor: colors[babySelect].weight,
                        backgroundColor: colors[babySelect].weightBg,
                        yAxisID: chartType === 'both' ? 'y1' : 'y',
                        tension: 0.4
                    });
                }
            }
            
            // 格式化日期显示
            const originalLabels = babySelect === 'all' ? labels : data.map(item => item['日期']);
            const formattedLabels = formatDates(originalLabels);
            
            return {
                labels: formattedLabels,
                datasets: datasets
            };
        }
        
        // 渲染表格
        function renderTable() {
            const tbody = document.getElementById('data-body');
            
            // 获取选中的宝贝
            const selectedBabies = Array.from(document.querySelectorAll('.baby-checkbox:checked')).map(cb => cb.value);
            
            // 过滤数据
            let filteredData = babyData.filter(item => selectedBabies.includes(item['babyname']));
            
            // 按日期排序
            filteredData.sort((a, b) => {
                return b['日期'].localeCompare(a['日期']);
            });
            
            // 渲染表格内容
            tbody.innerHTML = filteredData.map(item => {
                return `
                    <tr>
                        <td>${item['日期']}</td>
                        <td>${item['babyname']}</td>
                        <td>${item['身高'] || '-'}</td>
                        <td>${item['体重'] || '-'}</td>
                        <td>${item['记录'] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // 添加新记录
        document.getElementById('add-record-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const babyname = document.getElementById('babyname').value;
            const date = document.getElementById('date').value; // 已经是YYYY-MM-DD格式
            const height = document.getElementById('height').value ? parseFloat(document.getElementById('height').value) : null;
            const weight = document.getElementById('weight').value ? parseFloat(document.getElementById('weight').value) : null;
            const record = document.getElementById('record').value || null;
            
            try {
                // 插入到数据库
                db.run(`
                    INSERT INTO Babydata (baby, date, height, weight, record)
                    VALUES (?, ?, ?, ?, ?)
                `, [babyname, date, height, weight, record]);
                
                // 更新内存数据
                const newRecord = {
                    'babyname': babyname,
                    '日期': date,
                    '身高': height !== null ? height : '',
                    '体重': weight !== null ? weight : '',
                    '记录': record || ''
                };
                
                // 添加到内存数据
                babyData.push(newRecord);
                
                // 更新图表和表格
                renderChart();
                renderTable();
                
                // 清空表单
                this.reset();
                
                alert('记录添加成功！');
            } catch (error) {
                console.error('Error adding record:', error);
                alert('添加记录失败：' + error.message);
            }
        });
        
        // Tab切换功能
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.getAttribute('data-tab');
                
                // 移除所有active类
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 添加active类到当前选中的tab
                btn.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });
        
        // 监听控件变化
        document.querySelectorAll('input[name="baby-select"]').forEach(radio => {
            radio.addEventListener('change', renderChart);
        });
        document.getElementById('chart-type').addEventListener('change', renderChart);
        document.querySelectorAll('.baby-checkbox').forEach(cb => {
            cb.addEventListener('change', renderTable);
        });
        
        // 初始化已通过SQL.js加载函数调用
    </script>
</body>
</html>